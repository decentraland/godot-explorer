
# Dependencies

Both android and iOS you need to clone ffmpeg-kit and build it.

## TODO
1. See what libraries from the kit should be compiled instead of using `--full`

## Android

### Prerequisites

1. Install Android SDK and NDK (version 27.1.12297006)
2. Install cargo-ndk for easier cross-compilation:
   ```bash
   cargo install cargo-ndk
   ```
3. Add Android target to rustup:
   ```bash
   rustup target add aarch64-linux-android
   ```

### Environment Setup

Ensure one of these environment variables is set:
- `ANDROID_NDK_HOME` pointing to your NDK installation
- `ANDROID_NDK` pointing to your NDK installation
- `ANDROID_SDK` or `ANDROID_HOME` pointing to your SDK (NDK will be found at `*/ndk/27.1.12297006`)

If none are set, the build will look for NDK at `~/Android/Sdk/ndk/27.1.12297006`

## iOS
After cloning `ffmpeg-kit` ensure you have the right environment to build it. Some tips:
1. Install one-by-one the brew dependencies `autoconf automake libtool pkg-config curl git doxygen nasm cmake gcc gperf texinfo yasm bison autogen wget gettext meson ninja ragel groff gtk-doc-tools libtasn1`
2. Ensure you `bison` version in your path is > 2.4 (`bison --help`), probably you need to add the brew isntalled to PATH

Add Rust target for iOS with:
`rustup target add aarch64-apple-ios`

The command to build it:
`bash ios.sh --full --disable-armv7 --disable-armv7s --disable-arm64-mac-catalyst --disable-arm64-simulator --disable-arm64e --disable-i386 --disable-x86-64 --disable-x86-64-mac-catalyst --disable-lib-fribidi --disable-lib-openssl --disable-lib-libass`
This only buils for arm64. `fribidi` and `libass` should be compiled but I got errors when I tried to include them.


# Build

## Android (Quick Start)

For Android builds, we now support cargo-ndk which makes the process much simpler:

```bash
# Install cargo-ndk if not already installed
cargo install cargo-ndk

# Build for Android
cargo run -- build --target android
```

The build system will automatically detect if cargo-ndk is available and use it. If not, it will fall back to the traditional build method.

## iOS

1. Once the build is done, you need to modify the `ios-build.sh` the line:
    - `export FFMPEG_DIR=$FFMPEG_FOLDER/prebuilt/apple-ios-arm64/ffmpeg` 
    - Replace $FFMPEG_FOLDER with your path where you clone ffmpeg_kit

2. Open godot (see the README.md on the root folder of this repo) and make an export of iOS. TeamID is required to export it.

3. Open the project generated with XCode and add the ffmpeg libraries:
    - Copy all the `.framework` folders of the $FFMPEG_FOLDER/prebuilt/bundle-apple-framework-ios to the folder generated by Godot
    - Go to the Project view, and go to File>Add file, select all the .frameworks and add them.
    - Select the app target and then the General tab
    - Scroll down to the "Framework, Libraries, and Embedded Content" section.
    - Make sure your framework is "Embed & Sign".

## Android

### Using cargo-ndk (Recommended)

The project now supports building with cargo-ndk, which simplifies the Android build process:

```bash
# From the root directory
cargo run -- build --target android
```

This will automatically:
- Download required V8 bindings
- Set up the correct cross-compilation environment
- Build with the appropriate features for Android

### Traditional Build Method

If cargo-ndk is not available, you can still use the traditional build script:

1. Modify the `android-build.sh` file:
    - Update `export FFMPEG_DIR=$FFMPEG_FOLDER/prebuilt/android-arm64/ffmpeg`
    - Replace $FFMPEG_FOLDER with your path where you cloned ffmpeg_kit

# Run
## Android
1. Open the editor and go to `Project` and click `Install Android Build Template` (only requires onces and you need to install export templates)
2. Add the next line in `godot/android/build/src/com/godot/game/GodotApp.java` after `public class GodotApp extends FullScreenGodotApp {`:
```
	// This block calls the JNI_OnLoad, needed for livekit 
	static {
		System.loadLibrary("dclgodot");
	}
```
3. Ensure the dependencies are copied: 
- from web-rtc: libwebrtc.jar 
- from ffmpeg: libavcodec, libavfilter, libavdevice, libavformat, libavutil, libswresample, libswscale