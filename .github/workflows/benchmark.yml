name: üìä Benchmark Report
on:
  workflow_call:  # Called from runner.yml
    secrets:
      BENCHMARK_AWS_ACCESS_KEY_ID:
        required: true
      BENCHMARK_AWS_SECRET_ACCESS_KEY:
        required: true
      BENCHMARK_AWS_ENDPOINT_URL:
        required: true
      BENCHMARK_AWS_S3_BUCKET:
        required: true

concurrency:
  group: ci-${{ github.actor }}-${{ github.head_ref || github.run_number }}-${{ github.ref }}-benchmark
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read

jobs:
  benchmark:
    name: Run Benchmark
    runs-on: gpu-godot-docker
    timeout-minutes: 45
    env:
      GODOT4_BIN: ${{ github.workspace }}/.bin/godot/godot4_bin
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          clean: true

      # Clean up stale state from previous runs on self-hosted runner
      - name: Clean workspace
        run: git clean -xdf

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.90"

      - name: Setup Vulkan and graphics rendering
        uses: ./.github/actions/setup-vulkan

      # Dependencies section
      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: cargo run -- install
        run: cargo run -- install

      # Build section
      - name: Build
        run: cargo run -- build --no-default-features --features use_deno,use_memory_debugger

      - name: Import Assets
        uses: ./.github/actions/import-assets
        with:
          cache: false

      - name: Run Benchmark
        env:
          DISABLE_MEMORY_DEBUGGER_LOGS: "1"
        run: |
          export DISPLAY=:99
          sudo Xvfb -ac :99 -screen 0 1280x1024x24 > /dev/null 2>&1 &
          cargo run -- run --no-default-features --features use_deno,use_memory_debugger --use-tuned-glibc -- --benchmark-report 2>&1 | tee benchmark_run.log

      - name: Collect Benchmark Results
        if: always()
        run: |
          # Find the user data directory (Godot creates it in different locations)
          USER_DATA_DIR=""
          if [ -d "$HOME/.local/share/godot/app_userdata/Decentraland" ]; then
            USER_DATA_DIR="$HOME/.local/share/godot/app_userdata/Decentraland"
          elif [ -d "$HOME/.godot/app_userdata/Decentraland" ]; then
            USER_DATA_DIR="$HOME/.godot/app_userdata/Decentraland"
          fi

          if [ -z "$USER_DATA_DIR" ]; then
            echo "‚ö†Ô∏è Could not find user data directory"
            exit 1
          fi

          echo "‚úì Found user data directory: $USER_DATA_DIR"

          # Copy benchmark results to workspace
          mkdir -p benchmark-results
          if [ -f "$USER_DATA_DIR/output/benchmark_report.csv" ]; then
            cp "$USER_DATA_DIR/output/benchmark_report.csv" benchmark-results/
            echo "‚úì Copied benchmark_report.csv"
          else
            echo "‚ö†Ô∏è benchmark_report.csv not found"
          fi

          # Copy the full benchmark run logs (captured by tee in Run Benchmark step)
          if [ -f "benchmark_run.log" ]; then
            cp benchmark_run.log benchmark-results/
            echo "‚úì Copied benchmark_run.log"
          else
            echo "‚ö†Ô∏è benchmark_run.log not found"
          fi

          # List what we collected
          echo "=== Benchmark Results ==="
          ls -lh benchmark-results/

      - name: Fetch Baseline from Main Branch
        if: always()
        run: |
          BASELINE_BRANCH="main"

          # Fetch recent commits from baseline branch (last 6 commits)
          git fetch origin ${BASELINE_BRANCH} --depth=6 2>/dev/null || true

          # Get list of recent commit SHAs
          COMMIT_LIST=$(git log refs/remotes/origin/${BASELINE_BRANCH} --format=%H -n 6 2>/dev/null || echo "")

          if [ -z "$COMMIT_LIST" ]; then
            echo "‚ö†Ô∏è Could not fetch commits from ${BASELINE_BRANCH}"
            echo "BASELINE_URL=" >> $GITHUB_ENV
            echo "BASELINE_FOUND=false" >> $GITHUB_ENV
            echo "BASELINE_BRANCH=" >> $GITHUB_ENV
            echo "BASELINE_SHA=" >> $GITHUB_ENV
            echo "BASELINE_SHA_SHORT=" >> $GITHUB_ENV
            echo "BASELINE_FALLBACK_COUNT=0" >> $GITHUB_ENV
            exit 0
          fi

          # Try to find a baseline, starting with latest commit
          BRANCH_PATH=$(echo "${BASELINE_BRANCH}" | sed 's/\//-/g')
          FOUND=false
          FALLBACK_COUNT=0

          for SHA in $COMMIT_LIST; do
            BASELINE_URL="https://benchmark-reports.dclexplorer.com/${BRANCH_PATH}/${SHA}/benchmark_report.csv"
            echo "üîç Checking for baseline at: ${BASELINE_URL}"

            # Check if the baseline exists (HTTP HEAD request)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${BASELINE_URL}" || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úì Found baseline at commit ${SHA} (fallback: ${FALLBACK_COUNT})"
              BASELINE_SHA_SHORT=$(echo "${SHA}" | cut -c1-7)

              # Store all baseline info in env
              echo "BASELINE_URL=${BASELINE_URL}" >> $GITHUB_ENV
              echo "BASELINE_FOUND=true" >> $GITHUB_ENV
              echo "BASELINE_BRANCH=${BASELINE_BRANCH}" >> $GITHUB_ENV
              echo "BASELINE_SHA=${SHA}" >> $GITHUB_ENV
              echo "BASELINE_SHA_SHORT=${BASELINE_SHA_SHORT}" >> $GITHUB_ENV
              echo "BASELINE_FALLBACK_COUNT=${FALLBACK_COUNT}" >> $GITHUB_ENV

              echo "üìä Baseline URL: ${BASELINE_URL}"
              echo "üìä Baseline Branch: ${BASELINE_BRANCH}"
              echo "üìä Baseline SHA: ${SHA} (${BASELINE_SHA_SHORT})"
              echo "üìä Fallback count: ${FALLBACK_COUNT}"
              FOUND=true
              break
            else
              echo "‚ö†Ô∏è No baseline found at ${SHA} (HTTP ${HTTP_CODE})"
              FALLBACK_COUNT=$((FALLBACK_COUNT + 1))
            fi
          done

          if [ "$FOUND" = "false" ]; then
            echo "‚ö†Ô∏è No baseline found in last 6 commits of ${BASELINE_BRANCH}"
            echo "BASELINE_URL=" >> $GITHUB_ENV
            echo "BASELINE_FOUND=false" >> $GITHUB_ENV
            echo "BASELINE_BRANCH=" >> $GITHUB_ENV
            echo "BASELINE_SHA=" >> $GITHUB_ENV
            echo "BASELINE_SHA_SHORT=" >> $GITHUB_ENV
            echo "BASELINE_FALLBACK_COUNT=0" >> $GITHUB_ENV
          fi

      - name: Convert CSV to Markdown
        if: always()
        run: |
          if [ -f "benchmark-results/benchmark_report.csv" ]; then
            # Convert with baseline comparison if URL is available
            if [ -n "${{ env.BASELINE_URL }}" ]; then
              python3 tests/convert_benchmark_csv_to_md.py \
                benchmark-results/benchmark_report.csv \
                benchmark-results/benchmark_report.md \
                --baseline-url "${{ env.BASELINE_URL }}"
            else
              python3 tests/convert_benchmark_csv_to_md.py \
                benchmark-results/benchmark_report.csv \
                benchmark-results/benchmark_report.md
            fi
            echo "‚úì Converted CSV to Markdown"
          else
            echo "‚ö†Ô∏è No CSV file to convert"
          fi

      - name: Upload CSV to S3
        if: always()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.BENCHMARK_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BENCHMARK_AWS_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL: ${{ secrets.BENCHMARK_AWS_ENDPOINT_URL }}
        run: |
          if [ -f "benchmark-results/benchmark_report.csv" ]; then
            # Get branch name and commit hash (use actual branch commit, not merge commit)
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              BRANCH_NAME="${{ github.head_ref }}"
              COMMIT_HASH="${{ github.event.pull_request.head.sha }}"
            else
              BRANCH_NAME="${{ github.ref_name }}"
              COMMIT_HASH="${{ github.sha }}"
            fi

            # Sanitize branch name (replace / with -)
            BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/\//-/g')

            # S3 path: {branch_name}/{hash}/benchmark_report.csv
            S3_PATH="s3://${{ secrets.BENCHMARK_AWS_S3_BUCKET }}/${BRANCH_NAME}/${COMMIT_HASH}/benchmark_report.csv"

            echo "üì§ Uploading to: ${S3_PATH}"
            echo "üì§ Endpoint: ${AWS_ENDPOINT_URL}"
            aws s3 cp benchmark-results/benchmark_report.csv "${S3_PATH}" \
              --endpoint-url "${AWS_ENDPOINT_URL}" \
              --content-type "text/csv"
            echo "‚úì Uploaded benchmark CSV to S3"
          else
            echo "‚ö†Ô∏è No CSV file to upload"
          fi

      - name: Upload Benchmark Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-report
          path: |
            benchmark-results/benchmark_report.csv
            benchmark-results/benchmark_report.md
            benchmark-results/benchmark_run.log
          if-no-files-found: error
          retention-days: 90

      - name: Display Benchmark Summary
        if: always()
        run: |
          if [ -f "benchmark-results/benchmark_report.md" ]; then
            echo "=== Benchmark Report Summary ==="
            head -100 benchmark-results/benchmark_report.md
            echo ""
            echo "‚úÖ Full report available in artifacts"
          else
            echo "‚ö†Ô∏è No benchmark report generated"
          fi

      - name: Prepare PR Comment
        if: github.event_name == 'pull_request' && always()
        run: |
          # Get branch name and commit hash for S3 URL (use actual branch commit, not merge commit)
          BRANCH_NAME="${{ github.head_ref }}"
          COMMIT_HASH="${{ github.event.pull_request.head.sha }}"
          BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
          S3_BUCKET="${{ secrets.BENCHMARK_AWS_S3_BUCKET }}"
          # Cloudflare R2 public URL format
          S3_URL="https://benchmark-reports.dclexplorer.com/${BRANCH_NAME}/${COMMIT_HASH}/benchmark_report.csv"

          {
            echo "## üìä Benchmark Report"
            echo ""

            # Show baseline status (using env variables from previous step)
            if [ "${{ env.BASELINE_FOUND }}" = "true" ]; then
              if [ "${{ env.BASELINE_FALLBACK_COUNT }}" -gt 0 ]; then
                echo "> üìä **Baseline**: Comparing against \`${{ env.BASELINE_BRANCH }}\` branch at commit [\`${{ env.BASELINE_SHA_SHORT }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ env.BASELINE_SHA }}) (‚ö†Ô∏è used fallback: ${{ env.BASELINE_FALLBACK_COUNT }} commits back)"
              else
                echo "> üìä **Baseline**: Comparing against \`${{ env.BASELINE_BRANCH }}\` branch at commit [\`${{ env.BASELINE_SHA_SHORT }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ env.BASELINE_SHA }})"
              fi
              echo ""
            elif [ "${{ env.BASELINE_FOUND }}" = "false" ]; then
              echo "> ‚ö†Ô∏è **Note**: No baseline found for comparison. This report shows absolute values only."
              echo ""
            fi

            echo "<details>"
            echo "<summary>Click to expand full benchmark report</summary>"
            echo ""
            if [ -f "benchmark-results/benchmark_report.md" ]; then
              cat benchmark-results/benchmark_report.md
            else
              echo "‚ö†Ô∏è Benchmark report not generated"
            fi
            echo ""
            echo "</details>"
            echo ""
            echo "---"
            echo ""
            echo "### üìã Logs & Artifacts"
            echo ""
            echo "- üìä **CSV Data**: [benchmark_report.csv](${S3_URL}) - Raw benchmark data"
            if [ "${{ env.BASELINE_FOUND }}" = "true" ]; then
              echo "- üìä **Baseline CSV**: [benchmark_report.csv](${{ env.BASELINE_URL }}) - Baseline data from \`${{ env.BASELINE_BRANCH }}\` branch"
            fi
            echo "- üîß **Full Logs**: [benchmark_run.log](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts) - Complete benchmark run output (build + execution)"
            echo "- üåê **Workflow Run**: [View full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo "- üì¶ **Download All**: Get the \`benchmark-report\` artifact from the workflow run"
            echo ""
            echo "---"
            echo ""
            echo "üîÑ **Updated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          } > pr-comment.md

      - name: Comment PR with Benchmark Report
        if: github.event_name == 'pull_request' && always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: benchmark-report
          path: pr-comment.md
