name: üìä Benchmark Report
on:
  workflow_call:  # Called from runner.yml
    secrets:
      BENCHMARK_AWS_ACCESS_KEY_ID:
        required: true
      BENCHMARK_AWS_SECRET_ACCESS_KEY:
        required: true
      BENCHMARK_AWS_ENDPOINT_URL:
        required: true
      BENCHMARK_AWS_S3_BUCKET:
        required: true

concurrency:
  group: ci-${{ github.actor }}-${{ github.head_ref || github.run_number }}-${{ github.ref }}-benchmark
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read

jobs:
  benchmark:
    name: Run Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      GODOT4_BIN: ${{ github.workspace }}/.bin/godot/godot4_bin
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.90"

      - name: Set up cache
        uses: ./.github/actions/set-up-cache

      - name: Prepare graphics rendering
        run: |
          sudo apt-get -y install xvfb
          sudo /usr/bin/Xvfb :0 -screen 0 1280x1024x24 &

      # Dependencies section
      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: cargo run -- install
        run: cargo run -- install

      # Build section
      - name: Build
        run: cargo run -- build --no-default-features --features use_deno,use_memory_debugger

      - name: Import Assets
        uses: ./.github/actions/import-assets
        with:
          cache: false

      - name: Run Benchmark
        run: |
          export DISPLAY=:99
          sudo Xvfb -ac :99 -screen 0 1280x1024x24 > /dev/null 2>&1 &
          cargo run -- run --no-default-features --features use_deno,use_memory_debugger -- --benchmark-report 2>&1 | tee benchmark_run.log

      - name: Collect Benchmark Results
        if: always()
        run: |
          # Find the user data directory (Godot creates it in different locations)
          USER_DATA_DIR=""
          if [ -d "$HOME/.local/share/godot/app_userdata/Decentraland" ]; then
            USER_DATA_DIR="$HOME/.local/share/godot/app_userdata/Decentraland"
          elif [ -d "$HOME/.godot/app_userdata/Decentraland" ]; then
            USER_DATA_DIR="$HOME/.godot/app_userdata/Decentraland"
          fi

          if [ -z "$USER_DATA_DIR" ]; then
            echo "‚ö†Ô∏è Could not find user data directory"
            exit 1
          fi

          echo "‚úì Found user data directory: $USER_DATA_DIR"

          # Copy benchmark results to workspace
          mkdir -p benchmark-results
          if [ -f "$USER_DATA_DIR/output/benchmark_report.csv" ]; then
            cp "$USER_DATA_DIR/output/benchmark_report.csv" benchmark-results/
            echo "‚úì Copied benchmark_report.csv"
          else
            echo "‚ö†Ô∏è benchmark_report.csv not found"
          fi

          # Copy the full benchmark run logs (captured by tee in Run Benchmark step)
          if [ -f "benchmark_run.log" ]; then
            cp benchmark_run.log benchmark-results/
            echo "‚úì Copied benchmark_run.log"
          else
            echo "‚ö†Ô∏è benchmark_run.log not found"
          fi

          # List what we collected
          echo "=== Benchmark Results ==="
          ls -lh benchmark-results/

      - name: Fetch Baseline from Main Branch
        if: always()
        run: |
          # TODO: Change back to 'main' after merging to main
          # Temporarily using feat/benchmark-ci for testing
          BASELINE_BRANCH="feat/benchmark-ci"

          # Get the SHA of the baseline branch
          git fetch origin ${BASELINE_BRANCH} --depth=1 2>/dev/null || true
          MAIN_SHA=$(git rev-parse refs/remotes/origin/${BASELINE_BRANCH} 2>/dev/null || echo "")

          if [ -n "$MAIN_SHA" ] && [ "$MAIN_SHA" != "refs/remotes/origin/${BASELINE_BRANCH}" ]; then
            # Use branch name with / replaced by - for S3 path
            BRANCH_PATH=$(echo "${BASELINE_BRANCH}" | sed 's/\//-/g')
            BASELINE_URL="https://benchmark-reports.dclexplorer.com/${BRANCH_PATH}/${MAIN_SHA}/benchmark_report.csv"
            BASELINE_SHA_SHORT=$(echo "${MAIN_SHA}" | cut -c1-7)

            # Store all baseline info in env
            echo "BASELINE_URL=${BASELINE_URL}" >> $GITHUB_ENV
            echo "BASELINE_FOUND=true" >> $GITHUB_ENV
            echo "BASELINE_BRANCH=${BASELINE_BRANCH}" >> $GITHUB_ENV
            echo "BASELINE_SHA=${MAIN_SHA}" >> $GITHUB_ENV
            echo "BASELINE_SHA_SHORT=${BASELINE_SHA_SHORT}" >> $GITHUB_ENV

            echo "üìä Baseline URL: ${BASELINE_URL}"
            echo "üìä Baseline Branch: ${BASELINE_BRANCH}"
            echo "üìä Baseline SHA: ${MAIN_SHA} (${BASELINE_SHA_SHORT})"
          else
            echo "‚ö†Ô∏è Could not determine baseline branch SHA"
            echo "BASELINE_URL=" >> $GITHUB_ENV
            echo "BASELINE_FOUND=false" >> $GITHUB_ENV
            echo "BASELINE_BRANCH=" >> $GITHUB_ENV
            echo "BASELINE_SHA=" >> $GITHUB_ENV
            echo "BASELINE_SHA_SHORT=" >> $GITHUB_ENV
          fi

      - name: Convert CSV to Markdown
        if: always()
        run: |
          if [ -f "benchmark-results/benchmark_report.csv" ]; then
            # Convert with baseline comparison if URL is available
            if [ -n "${{ env.BASELINE_URL }}" ]; then
              python3 tests/convert_benchmark_csv_to_md.py \
                benchmark-results/benchmark_report.csv \
                benchmark-results/benchmark_report.md \
                --baseline-url "${{ env.BASELINE_URL }}"
            else
              python3 tests/convert_benchmark_csv_to_md.py \
                benchmark-results/benchmark_report.csv \
                benchmark-results/benchmark_report.md
            fi
            echo "‚úì Converted CSV to Markdown"
          else
            echo "‚ö†Ô∏è No CSV file to convert"
          fi

      - name: Upload CSV to S3
        if: always()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.BENCHMARK_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BENCHMARK_AWS_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL: ${{ secrets.BENCHMARK_AWS_ENDPOINT_URL }}
        run: |
          if [ -f "benchmark-results/benchmark_report.csv" ]; then
            # Get branch name and commit hash
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              BRANCH_NAME="${{ github.head_ref }}"
            else
              BRANCH_NAME="${{ github.ref_name }}"
            fi
            COMMIT_HASH="${{ github.sha }}"

            # Sanitize branch name (replace / with -)
            BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/\//-/g')

            # S3 path: {branch_name}/{hash}/benchmark_report.csv
            S3_PATH="s3://${{ secrets.BENCHMARK_AWS_S3_BUCKET }}/${BRANCH_NAME}/${COMMIT_HASH}/benchmark_report.csv"

            echo "üì§ Uploading to: ${S3_PATH}"
            echo "üì§ Endpoint: ${AWS_ENDPOINT_URL}"
            aws s3 cp benchmark-results/benchmark_report.csv "${S3_PATH}" \
              --endpoint-url "${AWS_ENDPOINT_URL}" \
              --content-type "text/csv"
            echo "‚úì Uploaded benchmark CSV to S3"
          else
            echo "‚ö†Ô∏è No CSV file to upload"
          fi

      - name: Upload Benchmark Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-report
          path: |
            benchmark-results/benchmark_report.csv
            benchmark-results/benchmark_report.md
            benchmark-results/benchmark_run.log
          if-no-files-found: error
          retention-days: 90

      - name: Display Benchmark Summary
        if: always()
        run: |
          if [ -f "benchmark-results/benchmark_report.md" ]; then
            echo "=== Benchmark Report Summary ==="
            head -100 benchmark-results/benchmark_report.md
            echo ""
            echo "‚úÖ Full report available in artifacts"
          else
            echo "‚ö†Ô∏è No benchmark report generated"
          fi

      - name: Prepare PR Comment
        if: github.event_name == 'pull_request' && always()
        run: |
          # Get branch name and commit hash for S3 URL
          BRANCH_NAME="${{ github.head_ref }}"
          COMMIT_HASH="${{ github.sha }}"
          BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
          S3_BUCKET="${{ secrets.BENCHMARK_AWS_S3_BUCKET }}"
          # Cloudflare R2 public URL format
          S3_URL="https://benchmark-reports.dclexplorer.com/${BRANCH_NAME}/${COMMIT_HASH}/benchmark_report.csv"

          {
            echo "## üìä Benchmark Report"
            echo ""

            # Show baseline status (using env variables from previous step)
            if [ "${{ env.BASELINE_FOUND }}" = "true" ]; then
              echo "> üìä **Baseline**: Comparing against \`${{ env.BASELINE_BRANCH }}\` branch at commit [\`${{ env.BASELINE_SHA_SHORT }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ env.BASELINE_SHA }})"
              echo ""
            elif [ "${{ env.BASELINE_FOUND }}" = "false" ]; then
              echo "> ‚ö†Ô∏è **Note**: No baseline found for comparison. This report shows absolute values only."
              echo ""
            fi

            echo "<details>"
            echo "<summary>Click to expand full benchmark report</summary>"
            echo ""
            if [ -f "benchmark-results/benchmark_report.md" ]; then
              cat benchmark-results/benchmark_report.md
            else
              echo "‚ö†Ô∏è Benchmark report not generated"
            fi
            echo ""
            echo "</details>"
            echo ""
            echo "---"
            echo ""
            echo "### üìã Logs & Artifacts"
            echo ""
            echo "- üìä **CSV Data**: [benchmark_report.csv](${S3_URL}) - Raw benchmark data in S3"
            echo "- üîß **Full Logs**: [benchmark_run.log](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts) - Complete benchmark run output (build + execution)"
            echo "- üåê **Workflow Run**: [View full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo "- üì¶ **Download All**: Get the \`benchmark-report\` artifact from the workflow run"
            echo ""
            echo "---"
            echo ""
            echo "üîÑ **Updated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          } > pr-comment.md

      - name: Comment PR with Benchmark Report
        if: github.event_name == 'pull_request' && always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: benchmark-report
          path: pr-comment.md
