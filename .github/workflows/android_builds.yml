name: ðŸ¤– Android (VR and Mobile)
on:
  workflow_call:
    secrets:
      ANDROID_KEYSTORE_BASE64:
        required: true
      ANDROID_KEYSTORE_PASSWORD:
        required: true

concurrency:
  group: ci-${{ github.actor }}-${{ github.head_ref || github.run_number }}-${{ github.ref }}-android
  cancel-in-progress: true

jobs:
  build:
    name: Build VR and Mobile
    runs-on: warp-ubuntu-latest-x64-8x
    container:
      # image generated at: https://github.com/decentraland/godot-docker-builder
      image: quay.io/decentraland/dcl-godot-android-builder:62ef6ebf357897ac382d7a52ac80de20883d9e15
      volumes:
        - /home/user/.cache/devgodot:/github/home/.cache/devgodot
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      - name: Add safe directory
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.79
          override: true
          components: clippy, rustfmt
      - name: Install Android targets
        run: |
          rustup target add aarch64-linux-android
      - name: Cargo install
        run: cargo run -- install --targets android linux
      - name: Build Rust libraries
        run: |
          cargo run -- build --release
          cargo run -- build --release --target android
          cargo run -- import-assets
      
      - name: Export Android APK
        run: |
          cargo run -- export --target android --format apk --release
      
      - name: Export Android AAB
        run: |
          cargo run -- export --target android --format aab
      
      - name: Export Quest APK
        run: |
          cargo run -- export --target quest --format apk --release

      # Decode and setup keystore for AAB signing
      - name: Setup AAB Signing Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > dclgodot.upload.jks
          ls -la dclgodot.upload.jks

      # Sign the AAB file
      - name: Sign Android AAB
        run: |
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore dclgodot.upload.jks \
            -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            -signedjar exports/decentraland.godot.client-signed.aab \
            exports/decentraland.godot.client.aab \
            upload

          # Verify the signature
          jarsigner -verify -verbose exports/decentraland.godot.client-signed.aab

          # Replace unsigned with signed
          mv exports/decentraland.godot.client-signed.aab exports/decentraland.godot.client.aab

      # Copy Android Artifacts
      - name: Copy Android Artifacts
        if: success() || failure()
        run: |
          pwd
          ls -la
          ls -la exports/
          mkdir -p android-artifacts-apk
          mkdir -p android-artifacts-aab
          mv exports/decentraland.godot.client.apk android-artifacts-apk/ || true
          mv exports/decentraland.godot.client.aab android-artifacts-aab/ || true

      - name: Copy Meta Quest Artifacts
        if: success() || failure()
        run: |
          mkdir -p meta-quest-artifacts
          mv exports/meta-quest.apk meta-quest-artifacts/ || true

      - uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: Android APK
          path: android-artifacts-apk/
          if-no-files-found: error

      - uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: Android AAB
          path: android-artifacts-aab/
          if-no-files-found: error

      - uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: Meta Quest APK
          path: meta-quest-artifacts/
          if-no-files-found: error

      - uses: actions/upload-artifact@v4
        with:
          name: libdclgodot_android
          path: |
            lib/target/aarch64-linux-android/release/libdclgodot.so
          if-no-files-found: error