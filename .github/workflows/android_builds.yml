name: ðŸ¤– Android (VR and Mobile)
on:
  workflow_call:
    secrets:
      ANDROID_KEYSTORE_BASE64:
        required: true
      ANDROID_KEYSTORE_PASSWORD:
        required: true
      SENTRY_AUTH_TOKEN:
        required: true
      SENTRY_ORG:
        required: true
      SENTRY_PROJECT:
        required: true

permissions:
  pull-requests: write
  contents: read

concurrency:
  group: ci-${{ github.actor }}-${{ github.head_ref || github.run_number }}-${{ github.ref }}-android
  cancel-in-progress: true

jobs:
  build:
    name: Build VR and Mobile
    runs-on: warp-ubuntu-latest-x64-8x
    timeout-minutes: 25
    container:
      # image generated at: https://github.com/decentraland/godot-docker-builder
      image: quay.io/decentraland/dcl-godot-android-builder:62ef6ebf357897ac382d7a52ac80de20883d9e15
      volumes:
        - /home/user/.cache/devgodot:/github/home/.cache/devgodot
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      - name: Add safe directory
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.90"
          components: clippy, rustfmt
      - name: Install Android targets
        run: |
          rustup target add aarch64-linux-android
      - name: Cargo install
        run: cargo run -- install --targets android linux

      - name: Set prod flag
        uses: ./.github/actions/set-prod-flag

      - name: Build Rust libraries
        run: |
          cargo run -- build --release ${{ env.PROD_FLAG }}
          cargo run -- build --release --target android ${{ env.PROD_FLAG }}
          cargo run -- import-assets
      
      - name: Export Android APK
        run: |
          cargo run -- export --target android --format apk --release
          mkdir -p android-debug-symbols
          cp godot/android/build/build/outputs/native-debug-symbols/standardRelease/native-debug-symbols.zip android-debug-symbols/ || true
      
      - name: Export Android AAB
        run: |
          cargo run -- export --target android --format aab --release

      # Decode and setup keystore for AAB signing
      - name: Setup AAB Signing Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > dclgodot.upload.jks
          ls -la dclgodot.upload.jks

      # Sign the AAB file
      - name: Sign Android AAB
        run: |
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore dclgodot.upload.jks \
            -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            -signedjar exports/decentraland.godot.client-signed.aab \
            exports/decentraland.godot.client.aab \
            upload

          # Verify the signature
          jarsigner -verify -verbose exports/decentraland.godot.client-signed.aab

          # Replace unsigned with signed
          mv exports/decentraland.godot.client-signed.aab exports/decentraland.godot.client.aab

      # Copy Android Artifacts
      - name: Copy Android Artifacts
        if: success() || failure()
        run: |
          pwd
          ls -la
          ls -la exports/
          mkdir -p android-artifacts-apk
          mkdir -p android-artifacts-aab
          mv exports/decentraland.godot.client.apk android-artifacts-apk/ || true
          mv exports/decentraland.godot.client.aab android-artifacts-aab/ || true

      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: AndroidAPK
          path: android-artifacts-apk/
          if-no-files-found: error

      - name: Upload AAB Artifacts
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: AndroidAAB
          path: android-artifacts-aab/
          if-no-files-found: error

      - name: Upload Android Debug Symbols
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: Android Native Debug Symbols
          path: android-debug-symbols/
          if-no-files-found: error
        
      # Upload debug symbols to Sentry for production builds
      - name: Upload debug symbols to Sentry
        if: success()
        shell: bash
        run: |
          EXPLORER_VERSION=$(cargo run -- explorer-version)
          echo "Explorer version: $EXPLORER_VERSION"

          # Check if this is a production build (no -dev suffix)
          if [[ ! "$EXPLORER_VERSION" =~ -dev$ ]]; then
            echo "Production build detected, uploading debug symbols to Sentry..."
            RELEASE_NAME="org.decentraland.godotexplorer@$EXPLORER_VERSION"
            echo "Release name: $RELEASE_NAME"

            # Install sentry-cli
            curl -sL https://sentry.io/get-cli/ | bash

            # Upload libdclgodot.so (our Rust library with embedded debug symbols)
            LIBDCLGODOT_PATH="lib/target/libdclgodot_android/libdclgodot.so"

            if [ -f "$LIBDCLGODOT_PATH" ]; then
              echo "Uploading libdclgodot debug symbols..."
              ls -lh "$LIBDCLGODOT_PATH"

              sentry-cli upload-dif \
                --org ${{ secrets.SENTRY_ORG }} \
                --project ${{ secrets.SENTRY_PROJECT }} \
                --auth-token ${{ secrets.SENTRY_AUTH_TOKEN }} \
                --include-sources \
                --wait \
                "$LIBDCLGODOT_PATH"

              echo "âœ… libdclgodot debug symbols uploaded"
            else
              echo "âš ï¸  libdclgodot.so not found at $LIBDCLGODOT_PATH"
            fi

            # Upload libgodot_android debug symbols from native-debug-symbols.zip
            # Search for the file as the path varies by build variant
            NATIVE_DEBUG_ZIP=$(find godot/android/build/build/outputs/native-debug-symbols -name "native-debug-symbols.zip" 2>/dev/null | head -1 || true)

            if [ -n "$NATIVE_DEBUG_ZIP" ] && [ -f "$NATIVE_DEBUG_ZIP" ]; then
              echo "Found native-debug-symbols.zip at: $NATIVE_DEBUG_ZIP"
              echo "Extracting Godot debug symbols..."
              mkdir -p /tmp/godot-debug-symbols
              unzip -o "$NATIVE_DEBUG_ZIP" "*/libgodot_android.so.dbg" -d /tmp/godot-debug-symbols || true

              GODOT_DBG=$(find /tmp/godot-debug-symbols -name "libgodot_android.so.dbg" 2>/dev/null | head -1 || true)
              if [ -n "$GODOT_DBG" ]; then
                echo "Uploading libgodot_android debug symbols..."
                ls -lh "$GODOT_DBG"

                sentry-cli upload-dif \
                  --org ${{ secrets.SENTRY_ORG }} \
                  --project ${{ secrets.SENTRY_PROJECT }} \
                  --auth-token ${{ secrets.SENTRY_AUTH_TOKEN }} \
                  --wait \
                  "$GODOT_DBG"

                echo "âœ… libgodot_android debug symbols uploaded"
              else
                echo "âš ï¸  libgodot_android.so.dbg not found in zip"
              fi
            else
              echo "âš ï¸  native-debug-symbols.zip not found, trying AAR fallback..."

              # Fallback: extract from godot-lib AAR (contains unstripped .so with debug symbols)
              GODOT_AAR="godot/android/build/libs/release/godot-lib.template_release.aar"
              if [ -f "$GODOT_AAR" ]; then
                echo "Extracting libgodot_android.so from AAR..."
                mkdir -p /tmp/godot-aar
                unzip -o "$GODOT_AAR" "jni/arm64-v8a/libgodot_android.so" -d /tmp/godot-aar

                GODOT_SO=$(find /tmp/godot-aar -name "libgodot_android.so" 2>/dev/null | head -1 || true)
                if [ -n "$GODOT_SO" ]; then
                  echo "Uploading libgodot_android from AAR..."
                  ls -lh "$GODOT_SO"

                  sentry-cli upload-dif \
                    --org ${{ secrets.SENTRY_ORG }} \
                    --project ${{ secrets.SENTRY_PROJECT }} \
                    --auth-token ${{ secrets.SENTRY_AUTH_TOKEN }} \
                    --wait \
                    "$GODOT_SO"

                  echo "âœ… libgodot_android uploaded from AAR"
                else
                  echo "âš ï¸  libgodot_android.so not found in AAR"
                fi
              else
                echo "âš ï¸  Godot AAR not found at $GODOT_AAR"
                find godot/android/build -name "*.aar" 2>/dev/null || true
              fi
            fi

            echo "Debug symbols uploaded successfully to release: $RELEASE_NAME"
          else
            echo "Development build detected (-dev suffix found), skipping Sentry upload"
          fi

      # Build Report Comment
      - name: Prepare Build Report
        if: github.event_name == 'pull_request' && always()
        run: |
          ARTIFACTS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Determine build status
          if [ "${{ job.status }}" = "success" ]; then
            ANDROID_STATUS="âœ… Success"
            APK_LINK="[ðŸ“± Download APK](${ARTIFACTS_URL}/artifacts)"
            AAB_LINK="[ðŸ“¦ Download AAB](${ARTIFACTS_URL}/artifacts)"
            SYMBOLS_LINK="[ðŸ”§ Debug Symbols](${ARTIFACTS_URL}/artifacts)"
          else
            ANDROID_STATUS="âŒ Failed"
            APK_LINK="Build failed"
            AAB_LINK="Build failed"
            SYMBOLS_LINK="Build failed"
          fi

          {
            echo "## ðŸ“¦ Build Report"
            echo ""
            echo "### ðŸ¤– Android"
            echo ""
            echo "| Artifact | Status |"
            echo "|----------|--------|"
            echo "| APK | ${APK_LINK} |"
            echo "| AAB | ${AAB_LINK} |"
            echo "| Debug Symbols | ${SYMBOLS_LINK} |"
            echo ""
            echo "**Build Status**: ${ANDROID_STATUS}"
            echo ""
            echo "### ðŸ iOS"
            echo ""
            echo "> iOS builds are triggered manually. Add the \`build-ios-internal\` label to trigger an iOS build."
            echo ""
            echo "---"
            echo ""
            echo "ðŸ”— **Workflow Run**: [View logs](${ARTIFACTS_URL})"
            echo ""
            echo "ðŸ”„ **Updated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          } > build-report.md

      - name: Comment PR with Build Report
        if: github.event_name == 'pull_request' && always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: build-report
          path: build-report.md