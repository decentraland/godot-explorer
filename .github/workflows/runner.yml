name: üîó GHA
on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ci-${{ github.actor }}-${{ github.head_ref || github.run_number }}-${{ github.ref }}-runner
  cancel-in-progress: true

jobs:
  # First stage: Fast formatting checks only
  static-checks:
    name: üìä Static checks
    uses: ./.github/workflows/static_checks.yml

  # Second stage: Clippy and build checks that require compilation
  clippy:
    name: üîß Clippy & Build Checks
    needs: static-checks
    uses: ./.github/workflows/clippy.yml

  # Third stage: Run all the builds and tests (all depend on static-checks)
  test-coverage:
    name: üîé Test & Coverage
    needs: static-checks
    uses: ./.github/workflows/coverage.yml

  android-build:
    name: ü§ñ Android (VR and Mobile)
    needs: static-checks
    uses: ./.github/workflows/android_builds.yml
    secrets:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
      SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

  ios-build:
    name: üçè iOS
    needs: static-checks
    # Skip iOS build if PR has 'without-ios' label
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'without-ios') }}
    uses: ./.github/workflows/ios_builds.yml
    secrets:
      DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}

  linux-build:
    name: üêß Linux
    needs: static-checks
    uses: ./.github/workflows/linux_builds.yml
  # Disable Windows and MacOS builds for now
  # macos-build:
  #   name: üçé macOS
  #   needs: static-checks
  #   uses: ./.github/workflows/macos_builds.yml

  # windows-build:
  #   name: üèÅ Windows
  #   needs: static-checks
  #   uses: ./.github/workflows/windows_builds.yml

  # # Third stage: Extras
  docker-build-test:
    name: üê≥ Docker builds and test
    needs: linux-build
    uses: ./.github/workflows/docker_build_test.yml
    secrets:
      QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
      QUAY_TOKEN: ${{ secrets.QUAY_TOKEN }}

  benchmark:
    name: üìä Benchmark Report
    needs: static-checks
    uses: ./.github/workflows/benchmark.yml
    secrets:
      BENCHMARK_AWS_ACCESS_KEY_ID: ${{ secrets.BENCHMARK_AWS_ACCESS_KEY_ID }}
      BENCHMARK_AWS_SECRET_ACCESS_KEY: ${{ secrets.BENCHMARK_AWS_SECRET_ACCESS_KEY }}
      BENCHMARK_AWS_ENDPOINT_URL: ${{ secrets.BENCHMARK_AWS_ENDPOINT_URL }}
      BENCHMARK_AWS_S3_BUCKET: ${{ secrets.BENCHMARK_AWS_S3_BUCKET }}
