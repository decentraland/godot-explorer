on:
  push:
    branches:
      - main
  pull_request:
  release:
    types:
      - created

name: CI

jobs:
  # TODO: back later
  # lints:
  #   name: Check and lints
  #   runs-on: ubuntu-latest
  #   env:
  #     GODOT4_BIN: ${{ github.workspace }}/.bin/godot/godot4_bin
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: actions-rs/toolchain@v1
  #       with:
  #         profile: minimal
  #         toolchain: stable
  #         override: true
  #     - run: rustup component add rustfmt
  #     - name: Set up Python
  #       uses: actions/setup-python@v4
  #     - name: Install gdtoolkit 4
  #       run: pip3 install "gdtoolkit==4.*"
  #     - name: Check format GDScript
  #       run: gdformat -d godot/
  #     - name: cargo xtask install
  #       working-directory: rust
  #       run: cargo xtask install --no-templates
  #     - uses: actions-rs/cargo@v1
  #       name: cargo check
  #       with:
  #         command: check
  #         args: --manifest-path rust/Cargo.toml
  #     - uses: actions-rs/cargo@v1
  #       name: cargo fmt
  #       with:
  #         command: fmt
  #         args: --manifest-path rust/Cargo.toml --all -- --check
  #     - uses: actions-rs/cargo@v1
  #       name: cargo clippy
  #       with:
  #         command: clippy
  #         args: --manifest-path rust/Cargo.toml -- -D warnings

  # coverage:
  #   name: Coverage
  #   strategy:
  #     matrix:
  #       os: [ubuntu-latest]
  #       rust: [stable]
  #   runs-on: ${{ matrix.os }}
  #   env:
  #     GODOT4_BIN: ${{ github.workspace }}/.bin/godot/godot4_bin
  #   steps:
  #     - name: Checkout sources
  #       uses: actions/checkout@v2
          
  #     - name: Install stable toolchain
  #       uses: actions-rs/toolchain@v1
  #       with:
  #         toolchain: ${{ matrix.rust }}
  #         override: true
  #         components: llvm-tools-preview

  #     - name: Cache
  #       uses: actions/cache@v2
  #       with:
  #         path: |
  #           ~/.cargo/registry
  #           ~/.cargo/git
  #           rust/target
  #           rust/Cargo.lock
  #         key: coverage-cargo-${{ hashFiles('**/Cargo.lock') }}
  #         restore-keys: coverage-cargo-
      
  #     - name: cargo xtask install
  #       working-directory: rust
  #       run: cargo xtask install --no-templates

  #     - name: Download grcov
  #       run: |
  #         mkdir -p "${HOME}/.local/bin"
  #         curl -sL https://github.com/mozilla/grcov/releases/download/v0.8.10/grcov-x86_64-unknown-linux-gnu.tar.bz2 | tar jxf - -C "${HOME}/.local/bin"
  #         echo "$HOME/.local/bin" >> $GITHUB_PATH

  #     - name: Run xtask coverage
  #       working-directory: rust
  #       run: cargo xtask coverage

  #     - name: Upload to codecov.io
  #       uses: codecov/codecov-action@v3
  #       with:
  #         files: rust/coverage/*.lcov

  build:
    name: Build and test
    # if: ${{ github.ref == 'refs/heads/main' }}
    if: false
    strategy:
      matrix:
        # os: [windows-latest, ubuntu-latest]
        os: [macos-latest]
        rust: [stable]
    runs-on: ${{ matrix.os }}
    env:
      GODOT4_BIN: ${{ github.workspace }}/.bin/godot/godot4_bin
    continue-on-error: true
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - name: Set up cargo cache
        uses: actions/cache@v3
        continue-on-error: false
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/            
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
          
      - name: cargo xtask install
        working-directory: rust
        run: cargo xtask install

      - name: Set up target platform
        if: ${{ matrix.os == 'macos-latest' }}
        run: |
          rustup target add x86_64-apple-darwin 
          rustup target add aarch64-apple-darwin

      - uses: actions-rs/cargo@v1
        if: ${{ matrix.os != 'macos-latest' }}
        name: cargo build
        with:
          command: build
          args: --manifest-path rust/Cargo.toml --release

      - uses: actions-rs/cargo@v1
        name: build for x86_64 (macos)
        if: ${{ matrix.os == 'macos-latest' }}
        with:
          command: build
          args: --manifest-path rust/Cargo.toml --release --target=x86_64-apple-darwin
          
      - uses: actions-rs/cargo@v1
        name: build for arm64 (macos)
        if: ${{ matrix.os == 'macos-latest' }}
        with:
          command: build
          args: --manifest-path rust/Cargo.toml --release --target=aarch64-apple-darwin

      # - uses: actions-rs/cargo@v1
      #   name: cargo test
      #   with:
      #     command: test
      #     args: --manifest-path rust/Cargo.toml --release 

      - name: Make universal library
        if: ${{ matrix.os == 'macos-latest' }}
        run: |
          mkdir rust/target/release || true
          lipo -create rust/target/x86_64-apple-darwin/release/libdecentraland_godot_lib.dylib rust/target/aarch64-apple-darwin/release/libdecentraland_godot_lib.dylib -output rust/target/release/libdecentraland_godot_lib.dylib

      - name: Copy library (win)
        if: ${{ matrix.os == 'windows-latest' }}
        run: |
            cp rust/target/release/decentraland_godot_lib.dll godot/lib/
      - name: Copy library (unix)
        if: ${{ matrix.os != 'windows-latest' }}
        run: |
            cp rust/target/release/libdecentraland_godot_lib.so godot/lib/ || true
            cp rust/target/release/libdecentraland_godot_lib.dylib godot/lib/ || true

      - name: Export
        working-directory: rust
        run: cargo xtask export

      - name: Copy the library to exports
        run: cp rust/target/release/libdecentraland_godot_lib.dylib exports/libdecentraland_godot_lib.dylib

      - uses: actions/upload-artifact@master
        with:
          name: decentraland-godot-${{ matrix.os }}
          path: |
            exports/**/*
  
  macos-sign:
    name: Test sign macos
    strategy:
      matrix:
        # os: [windows-latest, ubuntu-latest]
        os: [macos-latest]
        rust: [stable]
    runs-on: ${{ matrix.os }}
    env:
      GODOT4_BIN: ${{ github.workspace }}/.bin/godot/godot4_bin
    continue-on-error: true
    steps:
      - name: create folder
        run: mkdir exports || true
      - name: download library
        run: curl -o exports/libdecentraland_godot_lib.dylib https://github.com/decentraland/godot-explorer/releases/download/v0.5.0-alpha/libdecentraland_godot_lib.dylib
      - name: Codesign executable
        env: 
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CSC_LINK }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CSC_KEY_PASSWORD }}
        run: |
          mkdir exports || true
          echo "Creating temp password"
          tmp_password=$(head -c 32 /dev/urandom | base64)
          echo "Dumping cert"
          echo $MACOS_CERTIFICATE | base64 --decode > certificate.p12
          echo "Creating keychain"
          security create-keychain -p $tmp_password build.keychain
          echo "Setting default keychain"
          security default-keychain -s build.keychain
          echo "Unlock keychain"
          security unlock-keychain -p $tmp_password build.keychain
          echo "Importing cert"
          security import certificate.p12 -k build.keychain -P $MACOS_CERTIFICATE_PWD -T /usr/bin/codesign
          echo "set-key-partition-list"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k $tmp_password build.keychain
          echo "running find identity"
          security find-identity -v
          echo "signing dcl library"
          /usr/bin/codesign --force -s C6D65E924E13D94F1B661543E29FAC46C5AC10AD ./exports/libdecentraland_godot_lib.dylib -v 
      - uses: actions/upload-artifact@master
        with:
          name: signed-decentraland-godot-${{ matrix.os }}
          path: |
            exports/**/*