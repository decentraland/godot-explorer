name: üóëÔ∏è Sync Branch Deletion

on:
  delete:

jobs:
  delete-branch:
    name: Delete branch in deploy pipeline
    if: github.event.ref_type == 'branch'
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH for deployment
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Delete branch in mobile deploy pipeline
        run: |
          # Get the deleted branch name
          BRANCH_NAME="${{ github.event.ref }}"

          echo "Branch '$BRANCH_NAME' was deleted from source repository"
          echo "Attempting to delete it from deploy pipeline..."

          # Clone the target repository using SSH (ssh-agent handles authentication)
          git clone git@github.com:decentraland/godot-mobile-deploy-pipeline.git deploy-repo

          cd deploy-repo

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if branch exists in deploy repo
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch '$BRANCH_NAME' exists in deploy pipeline. Deleting..."
            git push origin --delete "$BRANCH_NAME"
            echo "‚úÖ Branch '$BRANCH_NAME' deleted from deploy pipeline"
          else
            echo "‚ÑπÔ∏è Branch '$BRANCH_NAME' does not exist in deploy pipeline. Nothing to delete."
          fi

          # Cleanup
          cd ..
          rm -rf deploy-repo

      - name: Summary
        run: |
          echo "‚úÖ Branch deletion synchronized"
          echo "üì¶ Deploy Repository: https://github.com/decentraland/godot-mobile-deploy-pipeline"
          echo "üóëÔ∏è Deleted Branch: ${{ github.event.ref }}"
