name: üóëÔ∏è Sync Branch Deletion

on:
  delete:

jobs:
  delete-branch:
    name: Delete branch in deploy pipeline
    if: github.event.ref_type == 'branch'
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH for deployment
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Delete branch in mobile deploy pipeline
        run: |
          # Determine branch name based on event type
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME="PR-${{ github.event.pull_request.number }}-${{ github.head_ref || github.ref_name }}"
          else
            BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          fi

          echo "Branch '$BRANCH_NAME' was deleted from source repository"
          echo "Attempting to delete it from deploy pipeline..."

          # Initialize fresh repo (no need to clone, we only need to delete a remote branch)
          mkdir deploy-repo && cd deploy-repo
          git init
          GIT_SSH_COMMAND='ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes' git remote add origin git@github.com:decentraland/godot-mobile-deploy-pipeline.git

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if branch exists in deploy repo
          if GIT_SSH_COMMAND='ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes' git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch '$BRANCH_NAME' exists in deploy pipeline. Deleting..."
            GIT_SSH_COMMAND='ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes' git push origin --delete "$BRANCH_NAME"
            echo "‚úÖ Branch '$BRANCH_NAME' deleted from deploy pipeline"
          else
            echo "‚ÑπÔ∏è Branch '$BRANCH_NAME' does not exist in deploy pipeline. Nothing to delete."
          fi

          # Cleanup
          cd ..
          rm -rf deploy-repo

          echo "‚úÖ Branch deletion synchronized"
          echo "üì¶ Deploy Repository: https://github.com/decentraland/godot-mobile-deploy-pipeline"
          echo "üóëÔ∏è Deleted Branch: ${BRANCH_NAME}"

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
