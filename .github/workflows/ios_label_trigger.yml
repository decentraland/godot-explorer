name: üè∑Ô∏è iOS Label Trigger

on:
  pull_request:
    types: [labeled]

permissions:
  pull-requests: write
  contents: read
  actions: write

jobs:
  pre-build:
    name: Prepare iOS Build
    runs-on: ubuntu-latest
    if: ${{ github.event.label.name == 'build-ios-internal' || github.event.label.name == 'build-ios-external' }}
    steps:
      - name: Remove iOS build label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --remove-label "${{ github.event.label.name }}"

      - name: Cancel previous iOS builds for this branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get in-progress iOS workflow runs for this branch
          IN_PROGRESS_RUNS=$(gh run list \
            --workflow=ios_builds.yml \
            --repo ${{ github.repository }} \
            --branch ${{ github.event.pull_request.head.ref }} \
            --status in_progress \
            --json databaseId \
            --jq '.[].databaseId')

          # Also check for queued runs
          QUEUED_RUNS=$(gh run list \
            --workflow=ios_builds.yml \
            --repo ${{ github.repository }} \
            --branch ${{ github.event.pull_request.head.ref }} \
            --status queued \
            --json databaseId \
            --jq '.[].databaseId')

          ALL_RUNS="$IN_PROGRESS_RUNS $QUEUED_RUNS"

          for RUN_ID in $ALL_RUNS; do
            if [ -n "$RUN_ID" ]; then
              echo "Cancelling run: $RUN_ID"
              gh run cancel $RUN_ID --repo ${{ github.repository }} || true
            fi
          done

      - name: Post build started comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          COMMENT_BODY="---

          ### üçè iOS Build Triggered

          üîó **iOS Workflow**: [View iOS build](${WORKFLOW_URL})

          üìç **Branch**: \`${{ github.event.pull_request.head.ref }}\`

          üîÑ **Triggered**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

          # Find and update existing iOS comment or create new one
          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments --jq '.[] | select(.body | contains("build-report-ios") or contains("iOS Build Triggered") or contains("iOS Build Complete") or contains("iOS Build Failed") or contains("iOS Build Cancelled")) | .id' | head -1)

          if [ -n "$COMMENT_ID" ]; then
            gh api repos/${{ github.repository }}/issues/comments/${COMMENT_ID} -X PATCH -f body="${COMMENT_BODY}"
          else
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments -f body="${COMMENT_BODY}"
          fi

  ios-build:
    name: iOS Build
    needs: pre-build
    if: ${{ github.event.label.name == 'build-ios-internal' || github.event.label.name == 'build-ios-external' }}
    uses: ./.github/workflows/ios_builds.yml
    with:
      ref: ${{ github.event.pull_request.head.ref }}
      pr_number: ${{ github.event.pull_request.number }}
      external: ${{ github.event.label.name == 'build-ios-external' }}
    secrets: inherit
